<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:loc="clr-namespace:LocalizationResourceManager.Maui;assembly=LocalizationResourceManager.Maui"
             xmlns:vm="clr-namespace:Linguibuddy.ViewModels"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="Linguibuddy.Views.DictionaryPage"
             x:DataType="vm:DictionaryViewModel"
             Title="{loc:Translate Dictionary}">

    <Grid RowDefinitions="Auto, Auto, Auto, *" RowSpacing="15" Padding="0,10,0,0">

        <Grid ColumnDefinitions="*, Auto" Margin="20,5">
            <Entry Text="{Binding InputText}"
                   Placeholder="{loc:Translate DictionarySearchFieldPlaceholder}"
                   ReturnCommand="{Binding LookupWordCommand}"
                   VerticalOptions="Center"
                   ClearButtonVisibility="WhileEditing"
                   BackgroundColor="Transparent" />

            <ImageButton Grid.Column="1"
                         Command="{Binding LookupWordCommand}"
                         IsEnabled="{Binding IsLoading, Converter={toolkit:InvertedBoolConverter}}"
                         BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                         Source="{AppThemeBinding Light=search_100dp_light.png, Dark=search_100dp_dark.png}"
                         HeightRequest="44"
                         WidthRequest="44"
                         CornerRadius="15"
                         Padding="10"
                         VerticalOptions="Center"
                         Margin="10,0,0,0">
                <ImageButton.Shadow>
                    <Shadow Brush="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                            Offset="0,4" Radius="8" Opacity="0.4" />
                </ImageButton.Shadow>

                <ImageButton.Triggers>
                    <DataTrigger TargetType="ImageButton" Binding="{Binding IsLoading}" Value="True">
                        <Setter Property="Opacity" Value="0.5" />
                    </DataTrigger>
                </ImageButton.Triggers>
            </ImageButton>
        </Grid>

        <Grid Grid.Row="1" ColumnDefinitions="Auto, *" Margin="20,0" ColumnSpacing="15">
            <Label Text="{loc:Translate SaveTo}"
                   VerticalOptions="Center"
                   FontAttributes="Bold"
                   FontSize="14"
                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />

            <Border Grid.Column="1" StrokeShape="RoundRectangle 8" StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                    BackgroundColor="Transparent" Padding="10,10">
                <Picker ItemsSource="{Binding UserCollections}"
                        SelectedItem="{Binding SelectedCollection}"
                        ItemDisplayBinding="{Binding Name}"
                        Title="{loc:Translate SelectCollectionPlaceholder}"
                        TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                        TitleColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                        VerticalOptions="Center"
                        HorizontalOptions="Fill" />
            </Border>
        </Grid>

        <ActivityIndicator Grid.Row="2"
                           IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}"
                           HeightRequest="40"
                           WidthRequest="40"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Margin="0,20,0,0" />

        <CollectionView Grid.Row="3"
                        ItemsSource="{Binding SearchResults}"
                        Margin="20,10,20,0"
                        SelectionMode="None"
                        IsVisible="{Binding IsLoading, Converter={toolkit:InvertedBoolConverter}}">

            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="15" />
            </CollectionView.ItemsLayout>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:SearchResultItem">
                    <Border Padding="15"
                            StrokeShape="RoundRectangle 12"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray950}}"
                            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}">

                        <Grid RowDefinitions="Auto, Auto, Auto" ColumnDefinitions="*, Auto">

                            <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="5">
                                <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                    <Label Text="{Binding Word}"
                                           VerticalTextAlignment="Center"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" />

                                    <Label Text="{Binding Phonetic, StringFormat='/{0}/'}"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                           VerticalOptions="Center"
                                           FontSize="14" />

                                    <ImageButton
                                        Source="{AppThemeBinding Light=text_to_speech_24dp_light.png, Dark=text_to_speech_24dp_dark.png}"
                                        HeightRequest="40"
                                        WidthRequest="40"
                                        Aspect="AspectFit"
                                        Padding="{OnPlatform Android=5, WinUI=0}"
                                        VerticalOptions="Center"
                                        BackgroundColor="Transparent"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DictionaryViewModel}}, Path=PlayAudioCommand}"
                                        CommandParameter="{Binding .}">
                                        <ImageButton.Shadow>
                                            <Shadow Brush="Black" Opacity="0.2" Radius="2" Offset="1,1" />
                                        </ImageButton.Shadow>
                                    </ImageButton>

                                    <Label Text="{Binding PartOfSpeech}"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                           FontAttributes="Bold"
                                           TextTransform="Uppercase"
                                           FontSize="11"
                                           VerticalOptions="Center"
                                           Padding="6,2"
                                           BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource Gray900}}">
                                        <Label.Resources>
                                            <Style TargetType="Label">
                                                <Setter Property="VisualStateManager.VisualStateGroups">
                                                    <VisualStateGroupList>
                                                        <VisualStateGroup x:Name="CommonStates">
                                                            <VisualState x:Name="Normal" />
                                                        </VisualStateGroup>
                                                    </VisualStateGroupList>
                                                </Setter>
                                            </Style>
                                        </Label.Resources>
                                    </Label>
                                </HorizontalStackLayout>

                                <Label Text="{Binding Definition}"
                                       LineBreakMode="WordWrap"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray200}}" />

                                <Label Text="{Binding Example, StringFormat='Np: {0}'}"
                                       FontSize="13"
                                       FontAttributes="Italic"
                                       IsVisible="{Binding Example, Converter={toolkit:IsStringNotNullOrEmptyConverter}}"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>


                            <ImageButton Grid.Row="0" Grid.RowSpan="3" Grid.Column="1"
                                         Source="{AppThemeBinding Light=library_add_24dp_dark.png, Dark=library_add_24dp_light.png}"
                                         Aspect="Center"
                                         BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                         HeightRequest="44"
                                         WidthRequest="44"
                                         CornerRadius="22"
                                         Padding="0"
                                         VerticalOptions="Start"
                                         Margin="10,0,0,0"
                                         Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DictionaryViewModel}}, Path=AddItemToFlashcardsCommand}"
                                         CommandParameter="{Binding .}">
                                <ImageButton.Shadow>
                                    <Shadow Brush="{StaticResource PrimaryBrush}" Radius="5" Opacity="0.3" Offset="0,4" />
                                </ImageButton.Shadow>
                            </ImageButton>

                            <BoxView Grid.Row="1" Grid.Column="0"
                                     HeightRequest="1"
                                     Margin="0,10"
                                     Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}" />

                            <VerticalStackLayout Grid.Row="2" Grid.Column="0" Spacing="8">

                                <Grid ColumnDefinitions="Auto, Auto">
                                    <Button Text="{loc:Translate Translate}"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DictionaryViewModel}}, Path=TranslateItemCommand}"
                                            CommandParameter="{Binding .}"
                                            HeightRequest="30"
                                            FontSize="12"
                                            Padding="15,0"
                                            CornerRadius="18"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                            BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                            BorderWidth="1"
                                            IsVisible="{Binding ShowTranslateButton}" />

                                    <ActivityIndicator Grid.Column="1"
                                                       IsRunning="{Binding IsBusy}"
                                                       IsVisible="{Binding IsBusy}"
                                                       HeightRequest="25"
                                                       WidthRequest="25"
                                                       Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                                       Margin="10,0,0,0" />
                                </Grid>

                                <VerticalStackLayout Spacing="4"
                                                     IsVisible="{Binding Translation, Converter={toolkit:IsNotNullConverter}}">
                                    <HorizontalStackLayout Spacing="5" VerticalOptions="Center">
                                        <Image
                                            Source="{AppThemeBinding Light=translate_100dp_light.png, Dark=translate_100dp_dark.png}"
                                            WidthRequest="20" Aspect="AspectFit" VerticalOptions="Center" />
                                        <Label Text="{Binding Translation, StringFormat='{0}'}"
                                               TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                               FontAttributes="Bold"
                                               FontSize="16"
                                               VerticalOptions="Center" />
                                    </HorizontalStackLayout>

                                </VerticalStackLayout>
                            </VerticalStackLayout>

                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.EmptyView>
                <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="15">
                    <Label Text="{loc:Translate SearchEmpty}"
                           HorizontalOptions="Center"
                           FontSize="16"
                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>

        </CollectionView>
    </Grid>
</ContentPage>